# Implementation Plan: Floating AI Chatbot

**Branch**: `004-floating-chatbot` | **Date**: 2025-12-16 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/004-floating-chatbot/spec.md`

---

## Summary

Implement a floating AI chatbot widget for the Physical AI & Robotics Docusaurus book that provides seamless access to the existing RAG agent. Users can ask questions from any page without navigating away. The frontend uses React components integrated via Docusaurus Root swizzling, communicating with a FastAPI endpoint that wraps the existing agent logic.

---

## Technical Context

**Language/Version**: JavaScript (React 19.0), Python 3.10+
**Primary Dependencies**:
- Frontend: @docusaurus/core 3.9.2, React 19.0.0
- Backend: FastAPI, uvicorn, openai-agents, cohere, qdrant-client
**Storage**: Session-scoped React state (no persistence)
**Testing**: Manual testing (browser), Jest optional for components
**Target Platform**: Modern browsers (Chrome, Firefox, Safari, Edge)
**Project Type**: Web application (frontend + backend)
**Performance Goals**: <100ms panel open/close, 30s API timeout
**Constraints**: No streaming, no auth, session-only history
**Scale/Scope**: Single chatbot widget, ~10 files, minimal bundle impact

---

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Notes |
|-----------|--------|-------|
| I. Technical Accuracy | ✅ PASS | Uses existing verified RAG agent |
| II. Educational Clarity | ✅ PASS | Enhances learning with AI assistance |
| III. AI-Native Design | ✅ PASS | Integrates RAG chatbot per constitution |
| IV. Reproducibility | ✅ PASS | Setup documented in quickstart.md |
| V. Industry Relevance | ✅ PASS | Standard React + FastAPI patterns |
| VI. Open Knowledge | ✅ PASS | Modular component structure |

**RAG Chatbot Requirements** (Constitution Section):
- ✅ Full-Book Question Answering - Uses existing Qdrant retrieval
- ✅ Code Explanation - Agent handles via prompt
- ✅ Concept Clarification - Agent handles via prompt
- ⬜ Selected Text Q&A - Out of scope for this feature
- ⬜ Resource Recommendation - Out of scope for this feature

**Security Check** (Constitution Section):
- ✅ API keys via environment variables
- ✅ CORS properly configured
- ✅ No secrets in frontend code
- ✅ Input validation on backend

---

## Project Structure

### Documentation (this feature)

```text
specs/004-floating-chatbot/
├── spec.md              # Feature specification
├── plan.md              # This file
├── research.md          # Phase 0 research notes
├── data-model.md        # Data structures
├── quickstart.md        # Developer quickstart
├── contracts/
│   └── chat-api.yaml    # OpenAPI specification
└── tasks.md             # Generated by /sp.tasks
```

### Source Code (repository root)

```text
physical-ai-textbook/                    # Docusaurus frontend
├── src/
│   ├── theme/
│   │   └── Root.js                      # Swizzled root (global chatbot injection)
│   ├── components/
│   │   ├── HomepageFeatures/            # Existing component
│   │   └── Chatbot/                     # NEW: Chatbot component
│   │       ├── index.js                 # Main export
│   │       ├── ChatbotProvider.js       # State management context
│   │       ├── FloatingButton.js        # Floating button UI
│   │       ├── ChatPanel.js             # Chat panel container
│   │       ├── ChatMessage.js           # Message display
│   │       ├── api.js                   # Backend communication
│   │       └── styles.module.css        # Component styles
│   ├── css/
│   │   └── custom.css                   # Existing styles
│   └── pages/
├── docusaurus.config.js
├── package.json
└── .env                                 # API URL config

agent/                                   # Backend
├── main.py                              # Existing agent logic
├── api.py                               # NEW: FastAPI endpoint
├── pyproject.toml
└── .env                                 # API keys
```

**Structure Decision**: Web application with separate frontend (Docusaurus) and backend (FastAPI). Frontend integrates via Root swizzle pattern. Backend adds HTTP wrapper around existing agent.

---

## Architecture Diagram

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           USER BROWSER                                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│   ┌──────────────────────────────────────────────────────────────────┐  │
│   │                  Docusaurus Book (React SPA)                      │  │
│   │  ┌────────────────────────────────────────────────────────────┐  │  │
│   │  │  Root.js (swizzled)                                        │  │  │
│   │  │  └── ChatbotProvider (context)                             │  │  │
│   │  │       ├── state: { isOpen, messages, isLoading, error }    │  │  │
│   │  │       ├── actions: { toggle, send, retry, clear }          │  │  │
│   │  │       │                                                     │  │  │
│   │  │       ├── <OriginalRoot />  ─── Book Content               │  │  │
│   │  │       │                                                     │  │  │
│   │  │       ├── <FloatingButton /> ─── Fixed bottom-right        │  │  │
│   │  │       │   └── onClick: toggle panel                         │  │  │
│   │  │       │                                                     │  │  │
│   │  │       └── <ChatPanel />      ─── Overlay (when isOpen)     │  │  │
│   │  │           ├── <MessageList />                               │  │  │
│   │  │           │   └── <ChatMessage /> (user/AI messages)        │  │  │
│   │  │           ├── <LoadingIndicator /> (when isLoading)         │  │  │
│   │  │           ├── <ErrorMessage /> (when error)                 │  │  │
│   │  │           └── <InputArea />                                 │  │  │
│   │  │               ├── <TextInput />                             │  │  │
│   │  │               └── <SendButton />                            │  │  │
│   │  └────────────────────────────────────────────────────────────┘  │  │
│   └──────────────────────────────────────────────────────────────────┘  │
│                                                                          │
└────────────────────────────────┬─────────────────────────────────────────┘
                                 │
                                 │ HTTP POST /chat
                                 │ Request: {"query": "..."}
                                 │ Response: {"response": "..."}
                                 │ Timeout: 30 seconds
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         FASTAPI BACKEND                                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│   ┌──────────────────────────────────────────────────────────────────┐  │
│   │  api.py                                                          │  │
│   │  ├── CORS middleware (allow Docusaurus origin)                   │  │
│   │  ├── POST /chat                                                  │  │
│   │  │   ├── Validate request                                        │  │
│   │  │   ├── Call retrieve_context(query) → Qdrant                   │  │
│   │  │   ├── Call run_agent(query, context) → Groq/Llama             │  │
│   │  │   └── Return {"response": answer}                             │  │
│   │  └── GET /health                                                 │  │
│   └──────────────────────────────────────────────────────────────────┘  │
│                                                                          │
│   ┌────────────────┐    ┌────────────────┐    ┌────────────────────┐   │
│   │  main.py       │    │  Qdrant Cloud  │    │  Groq API          │   │
│   │  (agent logic) │    │  (vectors)     │    │  (Llama-3.3-70b)   │   │
│   └────────────────┘    └────────────────┘    └────────────────────┘   │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## Component Specifications

### 1. FloatingButton

**Purpose**: Persistent button in bottom-right corner to toggle chat panel

**Props**:
```typescript
interface FloatingButtonProps {
  onClick: () => void;
  isOpen: boolean;
}
```

**Behavior**:
- Fixed position: bottom 20px, right 20px
- Z-index: 1000 (above page content)
- Icon changes based on isOpen state
- Hover effect for visual feedback
- aria-label for accessibility

**Styling**:
- 56px × 56px circle
- Primary theme color background
- White icon (chat bubble / X)
- Box shadow for depth
- Smooth transition on hover

---

### 2. ChatPanel

**Purpose**: Overlay panel containing conversation interface

**Props**:
```typescript
interface ChatPanelProps {
  isOpen: boolean;
  onClose: () => void;
  messages: ChatMessage[];
  isLoading: boolean;
  error: string | null;
  onSend: (message: string) => void;
  onRetry: () => void;
  onClearError: () => void;
}
```

**Behavior**:
- Positioned above floating button (bottom-right)
- Appears with slide-up animation
- Close on X button, click outside, or Escape key
- Focus trapped within panel when open
- Scrollable message area (auto-scroll to bottom)

**Dimensions**:
- Width: 380px (desktop), 100% - 32px (mobile)
- Height: 500px (desktop), 60vh (mobile)
- Border radius: 12px

---

### 3. ChatMessage

**Purpose**: Display individual messages with visual differentiation

**Props**:
```typescript
interface ChatMessageProps {
  message: {
    id: string;
    content: string;
    sender: 'user' | 'ai';
    timestamp: Date;
  };
}
```

**Styling**:
- User messages: Right-aligned, primary color background
- AI messages: Left-aligned, muted background
- Timestamp: Small, below message
- Markdown support for AI responses (code blocks)

---

### 4. ChatbotProvider

**Purpose**: Context provider for global state management

**State**:
```typescript
interface ChatbotContextValue {
  isOpen: boolean;
  messages: ChatMessage[];
  isLoading: boolean;
  error: string | null;
  togglePanel: () => void;
  sendMessage: (content: string) => Promise<void>;
  retryLastMessage: () => void;
  clearError: () => void;
}
```

**Key Logic**:
- Message persistence across navigation (React state)
- Async API calls with error handling
- 30-second timeout implementation
- Deduplication of rapid submissions

---

### 5. API Module (api.js)

**Purpose**: Centralized backend communication

```typescript
interface ChatAPI {
  sendMessage(query: string): Promise<string>;
}

const API_URL = process.env.REACT_APP_CHAT_API_URL || 'http://localhost:8000';
const TIMEOUT_MS = 30000;
```

**Error Handling**:
| HTTP Status | Error Message |
|-------------|---------------|
| 400 | "Invalid request. Please try again." |
| 500 | "Server error. Please try again later." |
| 503 | "AI service unavailable. Please try again." |
| Network | "Connection failed. Check your internet." |
| Timeout | "Request timed out. Please try again." |

---

## Backend API Specification

### POST /chat

**File**: `agent/api.py`

```python
from fastapi import FastAPI, HTTPException
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel, Field
from main import create_agent, retrieve_context, Runner

app = FastAPI(title="Physical AI Textbook Chat API")

app.add_middleware(
    CORSMiddleware,
    allow_origins=[
        "https://physical-ai-textbook.vercel.app",
        "http://localhost:3000",
    ],
    allow_methods=["POST", "GET"],
    allow_headers=["Content-Type"],
)

class ChatRequest(BaseModel):
    query: str = Field(..., min_length=1, max_length=10000)

class ChatResponse(BaseModel):
    response: str

@app.post("/chat", response_model=ChatResponse)
async def chat(request: ChatRequest):
    try:
        context = retrieve_context(request.query)
        agent = create_agent()
        result = Runner.run_sync(agent, request.query, context=context)
        return ChatResponse(response=result.final_output)
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))

@app.get("/health")
async def health():
    return {"status": "healthy", "version": "1.0.0"}
```

---

## Implementation Phases

### Phase 1: Backend API (Priority: Critical)

1. Create `agent/api.py` with FastAPI app
2. Implement `/chat` endpoint wrapping existing agent
3. Add CORS middleware configuration
4. Add health check endpoint
5. Test locally with curl/Postman

### Phase 2: Frontend Foundation (Priority: Critical)

1. Swizzle Docusaurus Root component
2. Create `src/components/Chatbot/` directory structure
3. Implement ChatbotProvider with state management
4. Create basic FloatingButton component
5. Verify button appears on all pages

### Phase 3: Chat UI (Priority: High)

1. Implement ChatPanel component
2. Implement ChatMessage component
3. Add message list with scroll behavior
4. Add input area with send functionality
5. Style for light/dark themes

### Phase 4: Integration (Priority: High)

1. Implement api.js module
2. Connect frontend to backend
3. Add loading states
4. Add error handling
5. Implement 30-second timeout

### Phase 5: Polish (Priority: Medium)

1. Add animations (panel open/close)
2. Keyboard navigation (Escape to close)
3. Focus management
4. Accessibility attributes
5. Mobile responsiveness

### Phase 6: Testing & Deployment (Priority: Medium)

1. Manual testing across browsers
2. Test light/dark themes
3. Test page navigation
4. Deploy backend to hosting
5. Deploy frontend to Vercel
6. End-to-end production test

---

## Risk Assessment

| Risk | Probability | Impact | Mitigation |
|------|-------------|--------|------------|
| CORS misconfiguration | Medium | High | Test locally first, verify origin matching |
| Agent timeout | Medium | Medium | 30s timeout with retry UI |
| State lost on navigation | Low | High | Use React context at Root level |
| Theme incompatibility | Low | Medium | Use CSS variables throughout |
| Mobile layout issues | Medium | Medium | Test early, use responsive units |

---

## Complexity Tracking

> No constitution violations requiring justification.

---

## Success Criteria Mapping

| Success Criteria | Implementation |
|------------------|----------------|
| SC-001: 1-click access | FloatingButton fixed on all pages via Root swizzle |
| SC-002: No page reload | React state + fetch API |
| SC-003: 95% non-blocking | Async API calls, loading states |
| SC-004: Content readable | Fixed position panel, proper z-index |
| SC-005: <100ms open/close | CSS transitions, no network calls |
| SC-006: 5-message history | Array in React state |
| SC-007: Error in <5s | Timeout + error state |

---

## Next Steps

Run `/sp.tasks` to generate the actionable task list from this plan.
